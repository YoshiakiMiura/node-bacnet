# experimental nodejs BACnet wrapper

[![Build Status](https://travis-ci.org/relayr/node-bacnet.svg?branch=master)](https://travis-ci.org/relayr/node-bacnet)

This is an experiment to see if it is viable to build a thin wrapper around the
[bacnet-stack c library](http://bacnet.sourceforge.net/) using the Node.js addons api.

## Requirements

- node-v4 (node-v6 passes automated tests, but not currently used)

## Contents

- bacnet-stack/ - contains the full contents of the c library checked out from svn://svn.code.sf.net/p/bacnet/code/trunk/bacnet-stack
  - .svn/ - the svn db is checked in to make it easier to update to newer versions and in case we have something to push back to the c library - I don't know if this is a bad idea
- build/ - generated by the build - contains the compiled c++ addon bindings
- examples/ - some javascript examples of how to use the library
- include/ - c++ headers for the addon of the wrapper
- spec/ - tests for the wrapper as a whole
- src/ - contains the wrapper code
  - BacnetValue.cc - value wrapping a bacnet value and providing conversions to js equivalents
  - *conversion.cc - provides conversions between js and the BACnet structs
  - emitter.cc - emits js events into an EventEmitter in js-land asynchronously with events from the c code
  - functions.cc - contains the addon code that runs when functions are called from js
  - h_*.c - request and response message handlers - modified from code in bacnet-stack/demo/handlers
  - init.cc - runs on module initialisation
  - listen.cc - loop to read bacnet messages received by the stack and to clean up the transaction state machine 
  - module.cc - defines the js module
  - s_*.c - request and response senders - modified from code in bacnet-stack/demo/handlers
  - tsm.c - maintains state machines for bacnet request transactions

## License

The bacnet-stack code is provided under an eCos license, which is a GPL license with the exception that code linked to
it is not covered. For simplicity we would release the wrapper also under the eCos license.

Some code is additionally licensed under an MIT license.

## Technical considerations

- Currently this builds for OSX and Linux (x86)
- Some of the bacnet-stack code is static and so we are restricted to one instance per VM - the tests spawn various 
  devices in forked VMs 
- Many of the files I've included in the build are probably not needed and can be removed to reduce install time
- We may want to switch to a tag of the bacnet-stack instead of the random head on the day I started the project
- Segmentation is not supported in bacnet-stack (see below)
- I've seen failures occasionally when making requests concurrently 

## Installation

`npm install` should get everything you need. Though you may also need to install compiler tools - such as 
`build-essential` on Ubuntu.

## Operations

BACnet is a huge and impressive protocol suite - the scope of this project currently is only to cover the most basic 
operations which are needed for our use case and compliance.

Requests and responds to the following service requests:

- Who-Is
- I-Am
- WriteProperty
- ReadProperty
- SubscribeCOV - (in progress)

## Priorities remaining

12. Subscribe to COV
13. Try again to get 2 devices running on 1 process
15. Enable writing of the deviceid using WriteProperty - so it can be configured by the installer
16. Get cross-architecture tests running
17. Get cross-architecture to work
18. Make initialisation non-blocking
19. Use Valgrind to look for leaks

## Things we're not currently trying to support

- non-ip datalinks
- bbmp / remote device registration
- services other than those above
- bacnet routers

## Useful BACnet documentation

- [BACnet device IDs](http://kargs.net/BACnet/Foundations2012-BACnetDeviceID.pdf)
- [Segmentation in BACnet](http://www.chipkin.com/segementation-in-bacnet/)
- [The language of BACnet](http://www.bacnet.org/Bibliography/ES-7-96/ES-7-96.htm)


## Usage considerations

### Segmentation not supported

bacnet-stack doesn't support segmentation - so this client doesn't support segmentation. 

This can be worked around for large arrays (particularly object lists) by reading the length of the array (index 0) and 
then reading each element of the array. This should be OK if these arrays don't need to be subscribed using COV or read 
regularly.

Another option is that we find a way to get segmentation support, such as by merging this branch - 
https://svn.code.sf.net/p/bacnet/code/branches/jbennet/bacnet-stack-0-5-7/

## Known issues

### Issues with concurrent BACnet requests

It doesn't always happen, but at the moment its best to avoid concurrent requests.
